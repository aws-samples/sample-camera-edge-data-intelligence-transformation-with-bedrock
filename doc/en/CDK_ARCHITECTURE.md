# CDK Architecture Guide

This document describes the AWS CDK architecture (16 stacks) details and dependencies for CEDIX.

---

## Overview

CEDIX infrastructure is defined using AWS CDK (TypeScript).

**Directory Structure**:

```
infrastructure/cdk/
├── bin/
│   ├── cdk.ts               # Main CDK app
│   └── cdk-webapp.ts        # Web app dedicated CDK app
├── lib/
│   ├── config/
│   │   └── constants.ts     # Common constants
│   └── stacks/              # CDK stack definitions (16 files)
├── keys/                    # CloudFront signing RSA key pair (generated by setup-cloudfront-keys.sh)
├── cdk.config.json.template # Configuration template
├── cdk.json                 # CDK settings
├── package.json
├── tsconfig.json
├── run-cdk.sh               # CDK execution script
├── run-cdk-webapp.sh        # Web app deployment script
├── load-config.sh           # Load configuration
├── setup-cloudfront-keys.sh # CloudFront key setup
└── cleanup_resources.sh     # Resource cleanup
```

---

## CDK App Structure

| App | File | Description |
| --- | --- | --- |
| cdk | `bin/cdk.ts` | Deploys everything except webapp-stack |
| cdk-webapp | `bin/cdk-webapp.ts` | Deploys only webapp-stack |

**Reason for Separation**: WebAppStack needs to build after CloudFormation Output values are resolved, so it's separated as a different app.

---

## Core Stacks

### Always Deployed Stacks (8)

| Stack Name | File | Role |
| --- | --- | --- |
| **CloudFrontKeysStack** | `cloudfront-keys-stack.ts` | Secrets Manager reference for CloudFront signed URL key pair |
| **ApiEcrStack** | `api-ecr-stack.ts` | Build & push Docker image for API Lambda |
| **IngestionEcrStack** | `ingestion-ecr-stack.ts` | Docker image for OpenSearch Ingestion Lambda |
| **FoundationStack** | `foundation-stack.ts` | Foundation infrastructure: VPC, DynamoDB, S3, Cognito, ECS Cluster |
| **ApplicationStack** | `application-stack.ts` | Application layer: OpenSearch Serverless, API Lambda, API Gateway |
| **FrontendStack** | `frontend-stack.ts` | Frontend layer: CloudFront Distribution, OAC, S3 bucket policy |
| **BedrockStack** | `bedrock-stack.ts` | Bedrock AI analysis Lambda |
| **WebAppStack** | `webapp-stack.ts` | React app build & S3 deployment |

---

## ECR Stacks

### Dynamic Deployment Stacks (8)

Stacks that are deployed optionally when creating cameras or from the camera edit screen.

| Stack Name | File | Purpose |
| --- | --- | --- |
| **HlsYoloEcrStack** | `hlsyolo-ecr-stack.ts` | HLS+YOLOv9(MIT) object detection container |
| **HlsRecEcrStack** | `hlsrec-ecr-stack.ts` | HLS recording container |
| **S3RecEcrStack** | `s3rec-ecr-stack.ts` | S3 recording container |
| **S3YoloEcrStack** | `s3yolo-ecr-stack.ts` | S3+YOLO object detection container |
| **RtspReceiverEcrStack** | `rtsp-receiver-ecr-stack.ts` | RTSP receiver container (includes KVS SDK) |
| **RtspMovieEcrStack** | `rtsp-movie-ecr-stack.ts` | Test movie RTSP streaming container |
| **KvsBaseEcrStack** | `kvs-base-ecr-stack.ts` | KVS SDK + GStreamer base image |
| **RtmpServerEcrStack** | `rtmp-server-ecr-stack.ts` | RTMP server container (Go) |


## Deployment Dependencies

### Dependency Diagram
```
CloudFrontKeysStack (independent)
        ↓
ApiEcrStack (independent)
IngestionEcrStack (independent)
        ↓
FoundationStack
        ↓
ApplicationStack ← ApiEcrStack, IngestionEcrStack
        ↓
FrontendStack ← CloudFrontKeysStack, ApplicationStack
        ↓
BedrockStack ← FoundationStack
WebAppStack (separate app: cdk-webapp.ts)

ECR Stack group (independent, can be deployed in parallel)
```

### 
## Shell Scripts List

| Script | Role |
| --- | --- |
| `run-cdk.sh` | Main CDK command execution wrapper |
| `run-cdk-webapp.sh` | Web app deployment dedicated (SSM Parameter retrieval → build → deploy) |
| `setup-cloudfront-keys.sh` | CloudFront signing RSA key pair generation & Secrets Manager registration |
| `cleanup_resources.sh` | Full resource cleanup (dynamic stacks, EventBridge, S3, ECR, KVS, CDK stacks, SSM) |

---

## Deployment Steps

### Configuration File
Create `cdk.config.json`:
```bash
cp cdk.config.json.template cdk.config.json
```

Configuration contents:
```json
{
  "stackPrefix": "cedix-dev",
  "region": "ap-northeast-1",
  "s3AdditionalPrefix": "<unique-prefix>"
}
```

| Parameter | Description | Required |
| --- | --- | --- |
| `stackPrefix` | Prefix for all AWS resource names | ✅ |
| `region` | AWS region for deployment | ✅ |
| `s3AdditionalPrefix` | Additional prefix to ensure S3 bucket name global uniqueness | ✅ |

### Full Resource Batch Deployment
```bash
cd infrastructure/cdk

# CDK Bootstrap (first time only)
cdk bootstrap

# Create CloudFront signing keys
sudo rm -rf keys/
./setup-cloudfront-keys.sh

# Batch deploy main resources
./run-cdk.sh deploy --all

# Deploy web application
./run-cdk-webapp.sh deploy --all
```

Skip confirmation messages
```bash
./run-cdk.sh deploy --all --require-approval never
./run-cdk-webapp.sh deploy --all --require-approval never
```

### Individual Deployment (if batch deployment fails)

```bash
cd infrastructure/cdk

# CDK Bootstrap (first time only)
cdk bootstrap

# Setup Secrets
./run-cdk.sh deploy cedix-<prefix>-keys

# Deploy KVS base image first (30-60 minutes for first time)
# If batch deployment fails, running this alone first may help
./run-cdk.sh deploy cedix-<prefix>-kvs-base-ecr

# Create ECR repositories (API & Ingestion)
./run-cdk.sh deploy cedix-<prefix>-api-ecr cedix-<prefix>-ingestion-ecr

# Deploy foundation resources
./run-cdk.sh deploy cedix-<prefix>-foundation

# Deploy application resources
./run-cdk.sh deploy cedix-<prefix>-application

# Deploy frontend infrastructure
./run-cdk.sh deploy cedix-<prefix>-frontend

# Deploy Detector (AI detection) resources
./run-cdk.sh deploy cedix-<prefix>-bedrock

# Create ECR repositories for Collector & Camera
./run-cdk.sh deploy cedix-<prefix>-hlsyolo-ecr \
                    cedix-<prefix>-hlsrec-ecr \
                    cedix-<prefix>-s3rec-ecr \
                    cedix-<prefix>-s3yolo-ecr \
                    cedix-<prefix>-rtsp-receiver-ecr \
                    cedix-<prefix>-rtsp-movie-ecr

# Deploy web application (SPA)
./run-cdk-webapp.sh deploy cedix-<prefix>-webapp
```

### Check Stack List
```bash
./run-cdk.sh list
```


## Troubleshooting

### If Deployment Fails
1. Check the error message and redeploy only the relevant stack
2. Verify that dependent stacks have been deployed first
3. Check if `cdk.config.json` settings are correct

### Resource Cleanup
```bash
./cleanup_resources.sh
```

**Warning**: This script deletes all resources. Use with caution in production environments.

## Notes

1. **Circular Dependency Avoidance**: Uses L1 Construct (CfnDistribution, etc.) and Custom Resource
2. **Regression Prevention**: Hybrid of SSM Parameter persistence + Custom Resource for immediate updates
3. **KVS Base Dependency**: `rtmp-server-ecr` is only created if `kvs-base-ecr` SSM Parameter exists
4. **WebApp is Separate App**: Separated into `cdk-webapp.ts` to build after CloudFormation Output values are resolved
