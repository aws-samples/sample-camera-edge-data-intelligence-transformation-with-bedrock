# ベースイメージ (Vite開発サーバー用)
FROM node:22-alpine

# nodeユーザーのUID/GID確認（デフォルトは1000:1000）
# /appディレクトリをnodeユーザー所有で作成
RUN mkdir -p /app && chown -R node:node /app

WORKDIR /app

# nodeユーザーに切り替えてからインストール
USER node

# package.jsonとpackage-lock.jsonのみコピー
COPY --chown=node:node package.json package-lock.json* ./

# 依存関係のインストール（nodeユーザーで実行）
RUN npm install --legacy-peer-deps

# ソースコードはvolumeマウントで提供されるのでCOPYしない

# 開発サーバー実行用の環境変数設定
ENV NODE_ENV=development

# ポート公開
EXPOSE 3000

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1

# 開発サーバー起動 (Vite)
CMD ["npm", "start"]

