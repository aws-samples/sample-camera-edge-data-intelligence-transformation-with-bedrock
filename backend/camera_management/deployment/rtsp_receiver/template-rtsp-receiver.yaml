AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: RTSP Receiverç”¨CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

Parameters:
  CameraId:
    Type: String
    Default: camera001
    Description: ã‚«ãƒ¡ãƒ©IDï¼ˆECSã‚¿ã‚¹ã‚¯ç”¨ï¼‰
  RtspReceiverRepositoryUri:
    Type: String
    Description: RTSP Receiver ECRãƒªãƒã‚¸ãƒˆãƒªURIï¼ˆåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆï¼‰
  EcsTaskRoleArn:
    Type: String
    Description: ECSã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ARNï¼ˆåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆï¼‰
  EcsTaskExecutionRoleArn:
    Type: String
    Description: ECSã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã®ARNï¼ˆåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆï¼‰
  CollectorSecurityGroupId:
    Type: String
    Description: ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®IDï¼ˆåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆï¼‰
  CameraClusterName:
    Type: String
    Description: ã‚«ãƒ¡ãƒ©ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åï¼ˆåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆï¼‰
  PrivateSubnet1Id:
    Type: String
    Description: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ1ã®IDï¼ˆåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆï¼‰
  PrivateSubnet2Id:
    Type: String
    Description: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ2ã®IDï¼ˆåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆï¼‰
  StreamName:
    Type: String
    Description: Kinesis Video Streamå
  RtspUrl:
    Type: String
    Description: RTSPå…¥åŠ›URL
  RetentionPeriod:
    Type: String
    Default: "24"
    Description: KVSã‚¹ãƒˆãƒªãƒ¼ãƒ ä¿æŒæœŸé–“ï¼ˆæ™‚é–“ï¼‰
  FragmentDuration:
    Type: String
    Default: "500"
    Description: ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆæŒç¶šæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  StorageSize:
    Type: String
    Default: "512"
    Description: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚ºï¼ˆMBï¼‰
  GstreamerLogMode:
    Type: String
    Description: GStreamerãƒ­ã‚°å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ï¼ˆstdout or nullï¼‰
  LogsKmsKeyArn:
    Type: String
    Description: CloudWatch Logsæš—å·åŒ–ç”¨KMS Key ARN

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: python3.9
    Architectures:
      - x86_64
    Environment:
      Variables:
        PYTHONPATH: /var/task

Resources:
  # Kinesis Video Stream
  KinesisVideoStream:
    Type: AWS::KinesisVideo::Stream
    Properties:
      Name: !Ref StreamName
      DataRetentionInHours: !Ref RetentionPeriod
      MediaType: video/h264
      Tags:
        - Key: CameraId
          Value: !Ref CameraId
        - Key: Purpose
          Value: RTSP-Receiver-Stream

  # ECS ã‚¿ã‚¹ã‚¯å®šç¾©
  RtspReceiverTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Metadata:
      cdk_nag:
        rules_to_suppress:
          - id: AwsSolutions-ECS2
            reason: "ç’°å¢ƒå¤‰æ•°ã«ã¯ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯å«ã¾ã‚Œãšã€è¨­å®šå€¤(AWS_REGION, STREAM_NAMEç­‰)ã®ã¿"
    Properties:
      Family: !Sub "${CameraId}-rtsp-receiver-task"
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: 512
      Memory: 1024
      ExecutionRoleArn: !Ref EcsTaskExecutionRoleArn
      TaskRoleArn: !Ref EcsTaskRoleArn
      ContainerDefinitions:
        - Name: !Sub "${CameraId}-rtsp-receiver-container"
          Image: !Ref RtspReceiverRepositoryUri
          Essential: true
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref RtspReceiverLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: rtsp-receiver
          Environment:
            - Name: AWS_REGION
              Value: !Ref AWS::Region
            - Name: STREAM_NAME
              Value: !Ref StreamName
            - Name: RTSP_URL
              Value: !Ref RtspUrl
            - Name: RETENTION_PERIOD
              Value: !Ref RetentionPeriod
            - Name: FRAGMENT_DURATION
              Value: !Ref FragmentDuration
            - Name: STORAGE_SIZE
              Value: !Ref StorageSize
            - Name: GSTREAMER_LOG_MODE
              Value: !Ref GstreamerLogMode

  # ECS ã‚µãƒ¼ãƒ“ã‚¹
  RtspReceiverService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Sub "${CameraId}-rtsp-receiver-service"
      Cluster: !Ref CameraClusterName
      TaskDefinition: !Ref RtspReceiverTaskDefinition
      DesiredCount: 1
      LaunchType: FARGATE
      # ============================================================
      # ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç”¨: ECS Execæœ‰åŠ¹åŒ–
      # æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ã™ã‚‹ã“ã¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®ãŸã‚ï¼‰
      # aws ecs execute-command ã§ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®è¨­å®š
      # ============================================================
      EnableExecuteCommand: true
      # ============================================================
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref CollectorSecurityGroupId
          Subnets:
            - !Ref PrivateSubnet1Id
            - !Ref PrivateSubnet2Id
      ServiceConnectConfiguration:
        Enabled: true
      Tags:
        - Key: Description
          Value: Service for RTSP to KVS streaming

  # CloudWatch ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—
  RtspReceiverLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${CameraId}-rtsp-receiver"
      RetentionInDays: 14
      KmsKeyId: !Ref LogsKmsKeyArn

Outputs:
  KinesisVideoStreamArn:
    Description: ARN of the created Kinesis Video Stream
    Value: !GetAtt KinesisVideoStream.Arn
  KinesisVideoStreamName:
    Description: Name of the created Kinesis Video Stream
    Value: !Ref KinesisVideoStream
  RtspReceiverTaskDefinitionArn:
    Description: ARN of the RTSP Receiver Task Definition
    Value: !Ref RtspReceiverTaskDefinition
  RtspReceiverServiceName:
    Description: Name of the RTSP Receiver Service
    Value: !Ref RtspReceiverService
